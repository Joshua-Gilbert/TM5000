# TM5000 v3.3 Architecture and Structure

## Version 3.3 - Enhanced Stability with Symbol Conflict Resolution
*Released: June 2025*

### ğŸ—ï¸ System Architecture

TM5000 v3.3 maintains the proven modular architecture from v3.0+ while adding critical stability improvements through symbol conflict resolution and file I/O reliability enhancements.

### ğŸ“ File Structure

#### Core Source Files
```
TM5000/
â”œâ”€â”€ main.c              # Main program entry point and initialization
â”œâ”€â”€ tm5000.h            # Primary header with global definitions
â”œâ”€â”€ makefile            # OpenWatcom build configuration
â””â”€â”€ tm5000.exe          # Final executable (DOS 16-bit)
```

#### Module System
```
â”œâ”€â”€ modules.c           # Module configuration and GPIB communication
â”œâ”€â”€ modules.h           # Module type definitions and prototypes
â”œâ”€â”€ module_funcs.c      # Advanced module functions (âœ“ single source)
â””â”€â”€ module_funcs.h      # Function prototypes for module operations
```

#### User Interface
```
â”œâ”€â”€ ui.c                # Menu system and user interaction
â”œâ”€â”€ ui.h                # UI function prototypes
â”œâ”€â”€ graphics.c          # Graphics primitives and font rendering (âœ“ single source)
â””â”€â”€ graphics.h          # Graphics definitions and prototypes
```

#### Data Management
```
â”œâ”€â”€ data.c              # File I/O, configuration, measurements (âœ“ fseek fixed)
â”œâ”€â”€ data.h              # Data structure definitions
â”œâ”€â”€ print.c             # PostScript and text printing
â””â”€â”€ print.h             # Printing function prototypes
```

#### GPIB Communication
```
â”œâ”€â”€ gpib.c              # Core GPIB functions (âœ“ duplicates removed)
â”œâ”€â”€ gpib.h              # GPIB interface definitions
â””â”€â”€ ieeeio_w.c          # Low-level GPIB driver interface
```

#### Mathematical Functions
```
â”œâ”€â”€ math_functions.c    # FFT, statistics, waveform math
â””â”€â”€ math_functions.h    # Mathematical function prototypes
```

#### Legacy Support
```
â”œâ”€â”€ TM5000L.c           # Legacy monolithic code (reference only)
â””â”€â”€ graph_display_legacy.c  # Legacy graphics functions
```

### ğŸ”§ V3.3 Architectural Improvements

#### Symbol Conflict Resolution
- **Enhanced Modularity**: Each function has single authoritative source
- **Clean Compilation**: Zero linker warnings achieved
- **Predictable Behavior**: Eliminated random function calls from symbol conflicts

#### File I/O Reliability  
- **Robust Parsing**: Eliminated unreliable fseek operations
- **Buffered I/O Compatible**: Works reliably in DOS environments
- **Configuration Persistence**: Reliable save/load of .cfg and .tm5 files

#### Code Organization
```
Function Ownership (V3.3):
â”œâ”€â”€ ui.c                â† module_selection_menu() âœ“
â”œâ”€â”€ graphics.c          â† enhanced_font[] âœ“
â”œâ”€â”€ module_funcs.c      â† send_custom_command() âœ“
â”‚                       â† configure_dm5120_advanced() âœ“
â”‚                       â† configure_ps5004_advanced() âœ“
â”‚                       â† configure_ps5010_advanced() âœ“
â”‚                       â””â”€â”€ gpib_terminal_mode() âœ“
â””â”€â”€ [duplicates removed from gpib.c, modules.c, main.c]
```

### ğŸ“Š Memory Architecture

#### DOS Segment Layout
```
Code Segments:
â”œâ”€â”€ main.obj         ~   901 bytes (font data removed)
â”œâ”€â”€ gpib.obj         ~ 3,359 bytes (duplicates removed: -1,186 bytes)
â”œâ”€â”€ modules.obj      ~31,186 bytes (duplicates removed: -6,284 bytes)
â”œâ”€â”€ graphics.obj     ~ 8,753 bytes
â”œâ”€â”€ ui.obj           ~14,102 bytes
â”œâ”€â”€ data.obj         ~15,080 bytes
â”œâ”€â”€ print.obj        ~11,036 bytes
â”œâ”€â”€ math_functions.obj ~ 5,092 bytes
â”œâ”€â”€ module_funcs.obj ~ 7,484 bytes
â””â”€â”€ ieeeio_w.obj     ~   794 bytes

Total Reduction: ~7,470 bytes from duplicate elimination
```

#### Data Structures
```
Global State:
â”œâ”€â”€ measurement_system *g_system     # Module and data management
â”œâ”€â”€ control_panel_state g_control_panel  # Monitoring configuration
â”œâ”€â”€ graph_scale g_graph_scale        # Display scaling
â”œâ”€â”€ trace_info g_traces[10]          # Per-trace information
â””â”€â”€ Module Config Arrays:
    â”œâ”€â”€ dm5120_config g_dm5120_config[10]
    â”œâ”€â”€ dm5010_config g_dm5010_config[10]
    â”œâ”€â”€ ps5004_config g_ps5004_config[10]
    â”œâ”€â”€ ps5010_config g_ps5010_config[10]
    â”œâ”€â”€ dc5009_config g_dc5009_config[10]
    â”œâ”€â”€ dc5010_config g_dc5010_config[10]
    â””â”€â”€ fg5010_config g_fg5010_config[10]
```

### ğŸ”„ Module Interaction Flow

#### Startup Sequence
```
1. main() â†’ System initialization
2. init_gpib_system() â†’ GPIB driver setup
3. main_menu() â†’ User interface entry
4. configure_modules() â†’ Module detection/setup
5. sync_traces_with_modules() â†’ Display synchronization
```

#### Module Selection (V3.3 Fixed)
```
measurement_menu() â†’ continuous_monitor_setup() â†’ module_selection_menu()
                                                    â†“
                                            âœ“ ui.c implementation
                                            âœ— modules.c (removed)
                                            âœ— TM5000L.c (legacy)
```

#### File Operations (V3.3 Fixed)
```
save_settings() â†’ Section-based writing
load_settings() â†’ Direct section processing (no fseek)
    â†“
[ControlPanel] â†’ [Modules] â†’ [ModuleConfigs] â†’ [GraphScale]
    â†“                â†“
  goto direct    reliable parsing
  processing     (fseek eliminated)
```

### ğŸ› ï¸ Build System

#### Compilation Process
```
makefile targets:
â”œâ”€â”€ all (default)     # Build complete system
â”œâ”€â”€ wcl              # Single-command build
â”œâ”€â”€ clean            # Remove build artifacts
â””â”€â”€ help             # Display build information

Compiler: OpenWatcom C/C++ 1.9
Flags: -ml -2 -bt=dos -os -d0
Target: 16-bit DOS executable
```

#### Dependencies
```
Build Order:
1. main.obj â† tm5000.h
2. gpib.obj â† gpib.h, tm5000.h
3. modules.obj â† modules.h, tm5000.h, gpib.h
4. graphics.obj â† graphics.h, tm5000.h
5. ui.obj â† ui.h, tm5000.h, graphics.h, module_funcs.h, modules.h
6. data.obj â† data.h, tm5000.h
7. print.obj â† print.h, tm5000.h, graphics.h
8. math_functions.obj â† math_functions.h, tm5000.h
9. module_funcs.obj â† module_funcs.h, tm5000.h
10. ieeeio_w.obj â† IEEEIO.H
```

### ğŸ” Symbol Resolution (V3.3)

#### Clean Symbol Table
All functions now have single, authoritative definitions:

```
Symbol Ownership Map:
â”œâ”€â”€ UI Functions
â”‚   â”œâ”€â”€ main_menu() â†’ ui.c
â”‚   â”œâ”€â”€ measurement_menu() â†’ ui.c
â”‚   â””â”€â”€ module_selection_menu() â†’ ui.c âœ“ (fixed)
â”œâ”€â”€ Graphics Functions
â”‚   â”œâ”€â”€ clrscr() â†’ graphics.c
â”‚   â”œâ”€â”€ plot_pixel() â†’ graphics.c
â”‚   â””â”€â”€ enhanced_font[] â†’ graphics.c âœ“ (fixed)
â”œâ”€â”€ Module Functions
â”‚   â”œâ”€â”€ configure_modules() â†’ modules.c
â”‚   â”œâ”€â”€ send_custom_command() â†’ module_funcs.c âœ“ (fixed)
â”‚   â”œâ”€â”€ configure_dm5120_advanced() â†’ module_funcs.c âœ“ (fixed)
â”‚   â”œâ”€â”€ configure_ps5004_advanced() â†’ module_funcs.c âœ“ (fixed)
â”‚   â”œâ”€â”€ configure_ps5010_advanced() â†’ module_funcs.c âœ“ (fixed)
â”‚   â””â”€â”€ gpib_terminal_mode() â†’ module_funcs.c âœ“ (fixed)
â”œâ”€â”€ GPIB Functions
â”‚   â”œâ”€â”€ init_gpib_system() â†’ gpib.c
â”‚   â”œâ”€â”€ gpib_write() â†’ gpib.c
â”‚   â””â”€â”€ gpib_read() â†’ gpib.c
â””â”€â”€ Data Functions
    â”œâ”€â”€ save_settings() â†’ data.c âœ“ (fseek fixed)
    â”œâ”€â”€ load_settings() â†’ data.c âœ“ (fseek fixed)
    â”œâ”€â”€ save_data() â†’ data.c
    â””â”€â”€ load_data() â†’ data.c âœ“ (fseek fixed)
```

### ğŸ¯ Quality Metrics (V3.3)

#### Compilation Quality
- âœ… **Zero Linker Warnings** (previously 7 warnings)
- âœ… **Clean Symbol Table** (no duplicates)
- âœ… **Predictable Linking** (deterministic function resolution)

#### Code Quality
- âœ… **Single Source of Truth** (each function in one file)
- âœ… **Proper Modularity** (clear ownership boundaries)
- âœ… **Reduced Redundancy** (~7.5KB code size reduction)

#### Runtime Quality
- âœ… **No Stack Overflows** (symbol conflicts eliminated)
- âœ… **Reliable File I/O** (fseek issues resolved)
- âœ… **Predictable Behavior** (deterministic function calls)

### ğŸ“ˆ Version Evolution

#### V3.0 â†’ V3.1 â†’ V3.2 â†’ V3.3
```
V3.0: Modular architecture foundation
  â†“
V3.1: Full TM5000 module support
  â†“  
V3.2: Enhanced stability and bug fixes
  â†“
V3.3: Symbol conflict resolution + file I/O reliability
      (Production-ready with zero warnings)
```

### ğŸ”§ Development Guidelines

#### Symbol Management
1. **One Definition Rule**: Each function in exactly one .c file
2. **Header Consistency**: Declare functions only in appropriate .h files
3. **Legacy Isolation**: Keep TM5000L.c for reference only
4. **Warning Policy**: Zero tolerance for linker warnings

#### File I/O Standards
1. **No Unreliable fseek**: Use sequential parsing
2. **Buffered I/O Compatible**: Design for DOS environments
3. **Robust Error Handling**: Graceful degradation
4. **Section-Based Design**: Clear file format structure

#### Module Architecture
1. **Clear Ownership**: Each module owns its functions
2. **Interface Contracts**: Well-defined header interfaces
3. **Configuration Persistence**: Reliable save/restore
4. **GPIB Abstraction**: Hardware independence

---

**TM5000 v3.3 represents the culmination of modular design with production-grade stability. The elimination of symbol conflicts and file I/O reliability issues makes this the most stable and reliable version of the TM5000 system.**